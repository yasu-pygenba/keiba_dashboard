<h1>競馬場別 成績</h1>

<form method="get">
    

    <label>競馬場：</label>
    <select name="v">
        <option value="">全場</option>
        {% for v in venues %}
            <option value="{{ v }}" {% if selected_venue == v %}selected{% endif %}>{{ v }}</option>
        {% endfor %}
    </select>

    <label>コース：</label>
    <select name="s">
        <option value="">全コース</option>
        <option value="芝" {% if selected_surface == '芝' %}selected{% endif %}>芝</option>
        <option value="ダ" {% if selected_surface == 'ダ' %}selected{% endif %}>ダート</option>
    </select>

    <label>距離：</label>
    <select name="dist">
        <option value="">全距離</option>
        {% for dist in distances %}
            <option value="{{ dist }}" {% if selected_distance == dist|stringformat:"s" %}selected{% endif %}>{{ dist }}</option>
        {% endfor %}
    </select>

    <label>印：</label>
    <select name="axis">
        {% for a in axis_cols %}
            <option value="{{ a }}" {% if selected_axis == a %}selected{% endif %}>{{ a }}</option>
        {% endfor %}
    </select>

    <label>年：</label>
    <select name="y">
        <option value="">全期間</option>
        {% for y in years %}
            <option value="{{ y }}" {% if selected_year == y %}selected{% endif %}>{{ y }}</option>
        {% endfor %}
    </select>

    <label>日付：</label>
    <select name="d">
        <option value="">（年の合計）</option>
        {% for d in dates %}
            <option value="{{ d }}" {% if selected_date == d %}selected{% endif %}>{{ d }}</option>
        {% endfor %}
    </select>

    <div>
        <label>グラフ表示：</label>
        <select id="chartMode">
            <option value="both">ROI＋的中率</option>
            <option value="roi">ROIのみ</option>
            <option value="hit">的中率のみ</option>
        </select>
    </div>

    <button type="submit">表示</button>
</form>

<table border="1" cellpadding="6">
    <tr>
        <th>券種</th><th>投資</th><th>払戻</th><th>収支</th><th>回収率%</th><th>的中数</th><th>購入数</th><th>的中率%</th>
    </tr>
    {% for r in rows %}
    <tr>
        <td>{{ r.bet_type }}</td>
        <td>{{ r.total_bet_yen }}</td>
        <td>{{ r.total_return_yen }}</td>
        <td>{{ r.profit_yen }}</td>
        <td>{{ r.roi_pct }}</td>
        <td>{{ r.n_bets }}</td>
        <td>{{ r.n_hits }}</td>
        <td>{{ r.hit_rate_pct }}</td>
    </tr>
    {% endfor %}
</table>

<style>
.chart-wrapper {
  display: flex;
  gap: 24px;
  flex-wrap: wrap;
}

.chart-box {
  width: 420px;
  height: 260px;
}
</style>


<!-- グラフ -->
<h3>券種別ROI(%)</h3>
<div class="chart-wrapper">
    <div class="chart-box">
        <canvas id="roiChart" height="120"></canvas>
    </div>
</div>

{{ chart_rows|json_script:"chart-rows" }}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const rows = JSON.parse(document.getElementById("chart-rows").textContent);

const labels = rows.map(r => r.bet_type);
const roiData = rows.map(r => r.roi_pct);
const hitData = rows.map(r => r.hit_rate_pct);

const ctx = document.getElementById("roiChart").getContext("2d");

let chart = new Chart(ctx, {
  type: "bar",
  data: {
    labels,
    datasets: [
      { label: "ROI (%)", data: roiData, yAxisID: "y_roi" },
      { label: "的中率 (%)", data: hitData, yAxisID: "y_hit" }
    ]
  },
  options: {
    responsive: true,
    maintainAspectRatio: false,
    scales: {
      y_hit: {
        beginAtZero: true,
        max: 100,
        position: "left",
        ticks: { callback: v => v + "%" }
      },
      y_roi: {
        beginAtZero: true,
        max: 200,
        position: "right",
        grid: { drawOnChartArea: false },
        ticks: { callback: v => v + "%" }
      }
    }
  }
});


document.getElementById("chartMode").addEventListener("change", e => {
  const mode = e.target.value;

  chart.data.datasets = [];

  if (mode === "roi" || mode === "both") {
    chart.data.datasets.push({
      label: "ROI (%)",
      data: roiData,
      yAxisID: "y_roi"
    });
  }

  if (mode === "hit" || mode === "both") {
    chart.data.datasets.push({
      label: "的中率 (%)",
      data: hitData,
      yAxisID: "y_hit"
    });
  }

  chart.update();
});


</script>